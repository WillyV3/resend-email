#!/bin/bash
# resend-email - send email via Resend API
# Usage: resend-email -m "body" <to> <subject> [attachments...]
#    or: echo "body" | resend-email <to> <subject> [attachments...]

set -e

source ~/.config/resend/env

# Parse -m flag for message body
BODY=""
if [[ "$1" == "-m" ]]; then
    BODY="$2"
    shift 2
fi

TO_INPUT="$1"
SUBJECT="$2"
shift 2 2>/dev/null || { echo "Usage: resend-email -m \"body\" <to> <subject> [attachments...]" >&2; exit 1; }

# If no -m flag, read from stdin
if [[ -z "$BODY" ]]; then
    BODY=$(cat)
fi
[[ -n "$BODY" ]] || { echo "Error: empty message body (use -m \"body\" or pipe to stdin)" >&2; exit 1; }

# Temp file for payload
PAYLOAD=$(mktemp)
trap "rm -f $PAYLOAD" EXIT

# Build recipients JSON (comma-separated -> array)
TO=$(echo "$TO_INPUT" | tr ',' '\n' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | jq -R . | jq -s .)

# Start JSON
jq -n \
    --arg from "$RESEND_FROM" \
    --argjson to "$TO" \
    --arg subject "$SUBJECT" \
    --arg text "$BODY" \
    '{from: $from, to: $to, subject: $subject, text: $text}' > "$PAYLOAD"

# Add attachments if any
if [[ $# -gt 0 ]]; then
    ATTACH_FILE=$(mktemp)
    trap "rm -f $PAYLOAD $ATTACH_FILE" EXIT

    echo '[' > "$ATTACH_FILE"
    FIRST=true
    for FILE in "$@"; do
        [[ -f "$FILE" ]] || { echo "File not found: $FILE" >&2; exit 1; }
        FNAME=$(basename "$FILE")
        $FIRST || echo ',' >> "$ATTACH_FILE"
        echo -n '{"filename":"'"$FNAME"'","content":"' >> "$ATTACH_FILE"
        base64 -w 0 "$FILE" >> "$ATTACH_FILE"
        echo -n '"}' >> "$ATTACH_FILE"
        FIRST=false
    done
    echo ']' >> "$ATTACH_FILE"

    jq --slurpfile att "$ATTACH_FILE" '. + {attachments: $att[0]}' "$PAYLOAD" > "${PAYLOAD}.tmp"
    mv "${PAYLOAD}.tmp" "$PAYLOAD"
fi

# Send
RESPONSE=$(curl -s -X POST 'https://api.resend.com/emails' \
    -H "Authorization: Bearer $RESEND_API_KEY" \
    -H 'Content-Type: application/json' \
    -d @"$PAYLOAD")

if echo "$RESPONSE" | jq -e '.error' >/dev/null 2>&1; then
    echo "Error: $(echo "$RESPONSE" | jq -r '.error.message')" >&2
    exit 1
fi

echo "$RESPONSE" | jq -r '.id'
